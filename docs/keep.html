<!DOCTYPE >
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN">
  <head>
    <title>æè‚›è¿åŠ¨è®¡æ—¶å™¨</title>
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />

    <style>
      [v-cloak] {
        display: none;
      }
      .count-card {
        transition: margin 0.3s ease-in-out;
      }
      .mt-300 {
        margin-top: -325px;
      }
    </style>
  </head>
  <body>
    <!-- æ–‡å­—ï¼š<input type="text" value="ä½ å¥½å•Šï¼è¯·ç½—æ˜“åˆ°éª¨ç§‘ä¸€è¯Šå®¤å°±è¯Š" id="inpu" />
    <button onclick="sayTTS()">å‘å£°</button> -->
    <div id="app" v-cloak class="p-3">
      <div class="count-card card shadow text-center" :class="[status ? 'mt-0' : 'mt-300']">
        <div class="card-header">è®¡æ—¶è¿åŠ¨âœŒï¸å’ŒğŸ¤</div>
        <div class="card-body">
          <h5 class="card-title">{{currentCommand.text}}</h5>
          <p class="card-text" style="font-size: 50px">{{currentCommand.time}}</p>
          <button type="button" class="btn" @click="togglePaused" :class="[paused ? 'btn-primary' : 'btn-warning']">
            {{ pausedBtnText }}
          </button>
        </div>
        <div class="card-footer text-muted">{{currentCount}}</div>
      </div>
      <div class="mt-5">
        <button type="button" class="btn w-100" :class="[status ? 'btn-danger' : 'btn-success']" @click="toggleStatus">
          {{ MainBtnText }}
        </button>
      </div>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.prod.js"></script>
  <script>
    // function sayTTS() {
    //   var content = document.getElementById("inpu");
    //   console.log(content.value);
    //   const synth = window.speechSynthesis;
    //   const msg = new SpeechSynthesisUtterance();
    //   msg.text = content.value; // æ–‡å­—å†…å®¹
    //   msg.lang = "zh-CN"; // ä½¿ç”¨çš„è¯­è¨€:ä¸­æ–‡
    //   msg.volume = 0.8; // å£°éŸ³éŸ³é‡ï¼š0-1
    //   msg.rate = 1.5; // è¯­é€Ÿï¼š0-10
    //   msg.pitch = 0.8; // éŸ³é«˜ï¼š0-1
    //   synth.speak(msg); // æ’­æ”¾
    // }
    // function getVoice(text) {
    //   const msg = new SpeechSynthesisUtterance(text);
    //   //   return Object.assign(
    //   //     {
    //   //       text: "", // æ–‡å­—å†…å®¹
    //   //       lang: "zh-CN", // ä½¿ç”¨çš„è¯­è¨€:ä¸­æ–‡
    //   //       volume: 0.8, // å£°éŸ³éŸ³é‡ï¼š0-1
    //   //       rate: 1.5, // è¯­é€Ÿï¼š0-10
    //   //       pitch: 0.8, // éŸ³é«˜ï¼š0-1
    //   //     },
    //   //     msg
    //   //   );
    //   return msg;
    // }
    const sourceList = [{ label: "ç™¾åº¦", getUrl: function () {} }];
    const commandList = [
      { text: "æ”¶ç¼©", time: 10, voice: null },
      { text: "æ”¾æ¾", time: 10 },
    ];
    function speak(index) {
      // const synth = window.speechSynthesis;
      // synth.speak(getVoice(text)); // æ’­æ”¾
      const command = commandList[index];
      return new Promise(function (resolve, reject) {
        if (!command.voice) {
          command.voice = loadVoice(command.text);
        }
        command.voice.onended = function () {
          resolve();
        };
        command.voice.play();
      }).catch(function (err) {
        alert("è¯­éŸ³æ’­æ”¾é”™è¯¯");
      });
    }
    function speakTest(text) {
      // "http://tts.baidu.com/text2audio?lan=zh&ie=UTF-8&spd=4&text=ä½ å¥½å•Šï¼Œå¬èµ·æ¥å¥½æ†¨å•Š"
      // var url = "http://tts.baidu.com/text2audio?lan=zh&ie=UTF-8&text='" + encodeURI(text);
      var url = `https://fanyi.sogou.com/reventondc/synthesis?text=${text}&speed=1&lang=zh-CHS&from=translateweb&speaker=6`;
      // var url = `http://tts.youdao.com/fanyivoice?word=${text}&le=zh&keyfrom=speaker-target`;
      var n = new Audio(url);
      n.play();
      n.onended = function () {
        alert(1);
      };
    }
    function loadVoice(text) {
      var url = `https://fanyi.sogou.com/reventondc/synthesis?text=${text}&speed=1&lang=zh-CHS&from=translateweb&speaker=6`;

      const voice = new Audio(url);
      return voice;
    }
    function useCount() {
      // æ˜¯å¦åœ¨è®¡æ—¶
      const status = Vue.ref(false);
      // æ˜¯å¦æš‚åœ
      const paused = Vue.ref(false);
      // ä¸»æŒ‰é’®æ–‡æœ¬
      const MainBtnText = Vue.computed(function () {
        return status.value ? "ç»“æŸ" : "å¼€å§‹";
      });
      // æš‚åœæŒ‰é’®æ–‡æœ¬
      const pausedBtnText = Vue.computed(function () {
        return paused.value ? "ç»§ç»­" : "æš‚åœ";
      });

      const options = Vue.reactive({
        perTime: 10,
        totalCount: 20 * 60,
      });
      const currentCommand = Vue.reactive({
        text: "å£ä»¤",
        time: 0,
        count: options.totalCount,
        index: 0,
      });
      const currentCount = Vue.computed(function () {
        return Math.floor(currentCommand.count / 60) + ":" + (currentCommand.count % 60);
      });
      function toggleStatus() {
        if (!status.value) {
          start();
        } else {
          end();
        }
      }
      function togglePaused() {
        paused.value = !paused.value;
        if (!paused.value) {
          next();
        }
      }
      function start() {
        status.value = true;
        reset();
        currentCommand.index = commandList.length;
        next();
      }
      function end() {
        status.value = false;
        reset();
      }
      function reset() {
        currentCommand.text = "å£ä»¤";
        currentCommand.time = 0;
        currentCommand.count = options.totalCount;
        currentCommand.index = 0;
      }
      function next() {
        setTimeout(function () {
          // åŠæ—¶å®Œæ¯•
          if (currentCommand.count <= 0) {
            reset();
            return false;
          }
          // åœæ­¢
          if (!status.value || paused.value) {
            return false;
          }
          if (currentCommand.time <= 0) {
            // ä¸€è½®å¾ªç¯ç»“æŸ
            if (currentCommand.index >= commandList.length - 1) {
              currentCommand.index = 0;
            } else {
              currentCommand.index += 1;
            }
            const command = commandList[currentCommand.index];
            currentCommand.text = command.text;
            currentCommand.time = command.time;
            speak(currentCommand.index).then(next);
            // setTimeout(next, 500);
          } else {
            currentCommand.time -= 1;
            next();
          }
          currentCommand.count -= 1;
        }, 1000);
      }

      return { status, toggleStatus, paused, togglePaused, currentCommand, currentCount, MainBtnText, pausedBtnText };
    }
    Vue.createApp({
      setup() {
        const countObj = useCount();
        return { ...countObj };
      },
    }).mount("#app");
  </script>
</html>
